# chibi-lisp

<p align="center">
    <img src="lambda.svg" alt="lambda" width="120">
</p>

C言語で実装された、小規模なLispインタプリタ処理系

## 目次

- [chibi-lisp](#chibi-lisp)
  - [目次](#目次)
  - [🎯 目標](#-目標)
  - [🧱 処理系の構成要素](#-処理系の構成要素)
  - [📝 実装仕様と制限](#-実装仕様と制限)
    - [メモリ管理](#メモリ管理)
    - [定数とバッファサイズ](#定数とバッファサイズ)
    - [データ型の内部表現](#データ型の内部表現)
      - [基本型](#基本型)
      - [メモリレイアウト](#メモリレイアウト)
    - [文字列とシンボルの管理](#文字列とシンボルの管理)
    - [エラー処理](#エラー処理)
    - [デバッグ機能](#デバッグ機能)
  - [�🔤 サポートしている構文](#-サポートしている構文)
    - [基本データ型](#基本データ型)
    - [特殊フォーム](#特殊フォーム)
    - [制御構造](#制御構造)
    - [算術演算子](#算術演算子)
    - [比較演算子](#比較演算子)
    - [REPLコマンド](#replコマンド)
    - [制限事項](#制限事項)
  - [🛠 開発環境のセットアップ](#-開発環境のセットアップ)
    - [必要な環境](#必要な環境)
    - [インストール・ビルド手順](#インストールビルド手順)
      - [1. 事前準備（OS別）](#1-事前準備os別)
        - [macOS](#macos)
        - [Windows](#windows)
      - [2. 共通手順](#2-共通手順)
  - [🔚 実行例](#-実行例)
    - [基本的な算術演算と変数定義](#基本的な算術演算と変数定義)
    - [条件分岐とブール演算](#条件分岐とブール演算)
    - [リストと再帰的な処理](#リストと再帰的な処理)
  - [🔄 今後の拡張](#-今後の拡張)

## 🎯 目標

小型のLispインタプリタをC言語で自作する。
- 基本的なS式の構文と評価に対応
- `define`, `lambda`, `if`, 再帰関数, 簡単なプリミティブ関数（+ - * /）をサポート
- 最初はGCなし、再帰とリストベースのデータ構造に焦点

---

## 🧱 処理系の構成要素

1. **字句解析（Tokenizer）**
    - Lispの入力文字列をトークンに分割する。
    - 例: `(+ 1 2)` → `["(", "+", "1", "2", ")"]`

2. **構文解析（Parser）**
    - トークン列からS式（リスト構造）を構築する。
    - 例: `(+ 1 2)` → `cons("+", cons(1, cons(2, nil)))`

3. **評価器（Evaluator）**
    - 構文木を評価し、結果を返す。
    - シンボルの評価、関数適用、条件分岐などを処理。

4. **環境（Environment）**
    - シンボル（変数や関数）のバインディングを保持。
    - 連想リストやハッシュテーブルで実装。

5. **REPL（Read Eval Print Loop）**
    - 対話型シェル。
    - 入力 → 評価 → 出力 を繰り返す。

6. **プリミティブ関数**
    - C言語で定義された基本操作。
    - `+`, `-`, `car`, `cdr`, `cons`, `eq?` など。

---

## 📝 実装仕様と制限

### メモリ管理
- **オブジェクトプール**: 512オブジェクト（固定長）
- **ヒープ領域**: 8KB（可変長データ用）
- **チャンクサイズ**: 16バイト
- **ガベージコレクション**: マーク&スイープ方式
- **ルートオブジェクト**: 最大32個

### 定数とバッファサイズ
- **入力行**: 最大512文字
- **シンボル名**: 最大64文字
- **文字列**: 最大256文字
- **再帰深度**: 最大100レベル
- **評価スタック**: 256要素
- **GCマークスタック**: 256要素

### データ型の内部表現

#### 基本型
```c
typedef enum {
    OBJ_NIL,      // nil値
    OBJ_BOOL,     // 真偽値
    OBJ_NUMBER,   // 整数のみ（32bit）
    OBJ_SYMBOL,   // シンボル
    OBJ_STRING,   // 文字列
    OBJ_LIST,     // リスト（cons cell）
    OBJ_FUNCTION, // 組み込み関数
    OBJ_LAMBDA,   // ユーザー定義関数（未実装）
    OBJ_CONS      // コンスセル（別名）
} ObjectType;
```

#### メモリレイアウト
- オブジェクトサイズ: 各オブジェクト約24-32バイト
- ヒープ使用率: 通常時20-30%、ピーク時70-80%
- GC実行頻度: 手動実行のみ（自動GCなし）

### 文字列とシンボルの管理

- **シンボルテーブル**: ハッシュ化なし、線形検索
- **文字列インターン**: 未実装
- **メモリリーク対策**: ヒープから動的割り当て・解放

### エラー処理

- **構文エラー**: パース時に検出
- **実行時エラー**: 基本的なチェックのみ
- **メモリ不足**: NULL返却、警告出力
- **スタックオーバーフロー**: 未チェック

### デバッグ機能

- **メモリ統計**: `:mem`コマンドで確認可能
- **GC統計**: 収集回数、解放オブジェクト数
- **デバッグモード**: `--debug`フラグで有効化
- **オブジェクトダンプ**: 内部構造の出力

## �🔤 サポートしている構文

### 基本データ型

- **数値**: 整数のみサポート

  ```lisp
  42
  -17
  0
  ```

- **シンボル**: 識別子として使用

  ```lisp
  hello
  variable-name
  my-function
  ```

- **文字列**: ダブルクォートで囲む

  ```lisp
  "Hello, World!"
  "test string"
  ```

- **リスト**: 括弧で囲んだS式

  ```lisp
  (1 2 3)
  (a b c)
  ()  ; 空リスト（nil）
  ```

### 特殊フォーム

- **`quote`**: 式をそのまま返す（評価しない）

  ```lisp
  (quote a)      ; => a
  (quote (1 2))  ; => (1 2)
  ```

- **`if`**: 条件分岐

  ```lisp
  (if condition then-expr else-expr)
  (if (> 5 3) "true" "false")  ; => "true"
  ```

### 制御構造

- **`while`**: 条件が真の間繰り返し

  ```lisp
  (while (< i 10) (+ i 1))
  ```

- **`dotimes`**: 指定回数繰り返し

  ```lisp
  (dotimes (i 5) (* i i))  ; 0から4まで繰り返し
  ```

- **`loop`**: 一般的なループ構造

  ```lisp
  (loop init condition update body)
  ```

### 算術演算子

- **`+`**: 加算（複数引数対応）

  ```lisp
  (+ 1 2)      ; => 3
  (+ 1 2 3 4)  ; => 10
  ```

- **`-`**: 減算（複数引数対応）

  ```lisp
  (- 10 3)     ; => 7
  (- 10 2 1)   ; => 7
  ```

- **`*`**: 乗算（複数引数対応）

  ```lisp
  (* 2 3)      ; => 6
  (* 2 3 4)    ; => 24
  ```

- **`/`**: 除算（複数引数対応、整数除算）

  ```lisp
  (/ 10 2)     ; => 5
  (/ 20 2 2)   ; => 5
  ```

### 比較演算子

- **`=`**: 等価比較

  ```lisp
  (= 3 3)      ; => true
  (= 3 4)      ; => false
  ```

- **`<`**: 未満

  ```lisp
  (< 2 5)      ; => true
  (< 5 2)      ; => false
  ```

- **`>`**: 超過

  ```lisp
  (> 5 2)      ; => true
  (> 2 5)      ; => false
  ```

- **`<=`**: 以下

  ```lisp
  (<= 3 3)     ; => true
  (<= 4 3)     ; => false
  ```

- **`>=`**: 以上

  ```lisp
  (>= 5 5)     ; => true
  (>= 4 5)     ; => false
  ```

### REPLコマンド

- **`:mem`**: メモリ統計の表示

  ```lisp
  :mem
  ```

- **`:help`**: ヘルプメッセージの表示

  ```lisp
  :help
  ```

- **`:quit`**: REPL終了

  ```lisp
  :quit
  ```

### 制限事項

- 変数定義（`define`）: 未実装
- ラムダ式（`lambda`）: 未実装
- リスト操作関数（`car`, `cdr`, `cons`）: 未実装
- 文字列操作: 基本的な表示のみ
- 浮動小数点数: 未サポート
- ガベージコレクション: 実装済みだが自動実行なし

---

## 🛠 開発環境のセットアップ

### 必要な環境

- C コンパイラ（gcc、clang、またはMSVC）
- CMake（バージョン3.10以上）
- Git

### インストール・ビルド手順

#### 1. 事前準備（OS別）

##### macOS

1. Homebrewのインストール（未導入の場合）
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

2. 必要なツールのインストール
```bash
brew install cmake ninja
xcode-select --install  # Command Line Toolsのインストール
```

##### Windows

1. [MSYS2](https://www.msys2.org/)をインストール
2. MSYS2から必要なパッケージをインストール：
```bash
# MSYS2のターミナルで実行
pacman -Syu
pacman -S mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-ninja git
```
3. `C:\msys64\mingw64\bin`をシステム環境変数PATHに追加

#### 2. 共通手順

1. ソースコードの取得
```bash
git clone https://github.com/mame7743/chibi-lisp.git
cd chibi-lisp
git submodule update --init --recursive
```

2. ビルドとテスト

```bash
# ビルドディレクトリの作成と移動
mkdir build && cd build

# ビルド
cmake -G Ninja .. && ninja

# テストの実行
ctest

# REPLの起動
./chibi-lisp[.exe]
```

注意事項：
- Windowsでは、全ての操作をMSYS2のMingw64シェルで実行してください
- `[.exe]`はWindowsの場合のみ付加してください
- 個別のテストを実行する場合は以下のコマンドを使用します：
  ```bash
  ./test_tokenizer[.exe]  # Tokenizerのテスト
  ./test_parser[.exe]     # Parserのテスト
  ./test_env[.exe]        # 変数・ラムダのテスト
  ```

---

## 🔚 実行例

### 基本的な算術演算と変数定義
```lisp
; 算術演算
> (+ 1 2 3 4)
10
> (* 2 3 4)
24
> (/ (- 100 20) 5)
16

; 変数の定義と使用
> (define radius 5)
> (define pi 3.14159)
> (* pi (* radius radius))  ; 円の面積
78.53975
```

### 条件分岐とブール演算
```lisp
; 基本的な条件分岐
> (if (> 5 3)
      'true
      'false)
true

; 複合条件
> (define x 10)
> (if (and (> x 5)
           (<= x 10))
      "範囲内です"
      "範囲外です")
"範囲内です"
```

### リストと再帰的な処理
```lisp
; リスト操作
> (define lst '(1 2 3 4 5))
> (car lst)     ; 先頭要素の取得
1
> (cdr lst)     ; 残りのリスト
(2 3 4 5)
> (cons 0 lst)  ; 新しいリスト作成
(0 1 2 3 4 5)

; 再帰関数の定義と使用
> (define sum
    (lambda (lst)
      (if (null? lst)
          0
          (+ (car lst)
             (sum (cdr lst))))))

> (sum lst)  ; リストの要素の合計
15

; 階乗計算
> (define factorial
    (lambda (n)
      (if (= n 0)
          1
          (* n (factorial (- n 1))))))

> (factorial 5)
120
```

---

## 🔄 今後の拡張

- 再帰・クロージャ対応
- ガベージコレクション（GC）追加
- バイトコードコンパイル
- ファイル読み込み・標準ライブラリの拡張